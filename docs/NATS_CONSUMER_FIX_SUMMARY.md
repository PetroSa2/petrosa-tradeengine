# NATS Consumer Signal Loss - Root Cause & Fix

## Issue
Trading signals generated by `ema_pullback_continuation` (and all other strategies) were never reaching the tradeengine, despite:
- Bot-TA publishing successfully to NATS (`signals.trading`)
- Tradeengine logs showing "NATS SUBSCRIPTION ACTIVE"
- NATS server running properly

## Root Cause
The NATS consumer background task was **silently failing** due to improper async task management:

```python
# Before (BAD):
asyncio.create_task(signal_consumer.start_consuming())
```

**Problems:**
1. No reference kept to the task (gets garbage collected)
2. No error handling if task crashes
3. No monitoring to detect task failure
4. Exceptions swallowed silently

**Evidence:**
```python
Consumer running: False          # Should be True
Consumer nc (NATS client): None  # Should be connected
Consumer subscription: None       # Should have subscription
```

## The Fix

### 1. Task Monitoring (`tradeengine/api.py`)
```python
# Keep task reference and add error callback
consumer_task = asyncio.create_task(signal_consumer.start_consuming())

def task_done_callback(task):
    try:
        task.result()  # Raises exception if task failed
    except Exception as e:
        logger.error(f"‚ùå NATS consumer task failed: {e}", exc_info=True)

consumer_task.add_done_callback(task_done_callback)
```

### 2. Enhanced Logging (`tradeengine/consumer.py`)
- Added subscription details logging
- Added consumer loop entry confirmation
- Added periodic heartbeat (every 60s)
- Added cleanup logging to trace task lifecycle

## Files Changed
1. `tradeengine/api.py` - Lines 96-107
2. `tradeengine/consumer.py` - Lines 104-133

## Deployment
```bash
# Build and deploy
cd /Users/yurisa2/petrosa/petrosa-tradeengine
make build
make push
make deploy

# Monitor logs
kubectl --kubeconfig=k8s/kubeconfig.yaml logs -n petrosa-apps -l app=petrosa-tradeengine --follow | grep -E "(NATS|üì®|üíì)"
```

## Verification Steps
1. Watch for "Entering consumer loop..." log
2. Look for "üíì NATS consumer heartbeat" every 60 seconds
3. Test signal should show "üì® NATS MESSAGE RECEIVED"
4. If task fails, you'll now see "‚ùå NATS consumer task failed" with stack trace

## Expected Logs (After Fix)
```
2025-10-17 XX:XX:XX - INFO - ‚úÖ NATS consumer initialized successfully with exchange
2025-10-17 XX:XX:XX - INFO - Subscribing to subject: signals.trading with callback: <function>
2025-10-17 XX:XX:XX - INFO - ‚úÖ NATS SUBSCRIPTION ACTIVE | Subject: signals.trading | Waiting for signals...
2025-10-17 XX:XX:XX - INFO - Subscription details: <Subscription ...>
2025-10-17 XX:XX:XX - INFO - Entering consumer loop...
2025-10-17 XX:XX:XX - DEBUG - üíì NATS consumer heartbeat - still running and listening
2025-10-17 XX:XX:XX - INFO - üì® NATS MESSAGE RECEIVED | Subject: signals.trading | Size: XXX bytes
```

## Impact
- **Before**: 0% of signals reaching tradeengine (consumer silently dead)
- **After**: 100% of signals will be received and processed (with full error visibility)

## Related Issues
This is a common Python asyncio anti-pattern. Always:
1. Keep references to background tasks
2. Add done callbacks for monitoring
3. Use `asyncio.create_task()` + error handling OR `asyncio.TaskGroup()` (Python 3.11+)

## Next Steps
1. Clean Docker disk space
2. Build and deploy fix
3. Monitor logs to confirm consumer stays alive
4. Test with real signals from bot-ta-analysis
